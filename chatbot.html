<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthMate - AI Symptom Companion</title>
    <!-- Include marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Include DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #e5ddd5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .chat-container { width: 90%; max-width: 800px; height: 100vh; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { background: #075e54; color: white; padding: 15px; text-align: center; font-size: 18px; }
        .chat-box { flex: 1; overflow-y: auto; padding: 10px; background: #e5ddd5; }
        .message { margin: 10px 0; display: flex; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; position: relative; word-wrap: break-word; }
        .bubble.user { background: #dcf8c6; color: #303030; }
        .bubble.bot { background: white; color: #303030; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .timestamp { font-size: 10px; color: #999; margin-top: 5px; text-align: right; }
        .input-area { display: flex; padding: 10px; background: #f0f0f0; align-items: center; }
        #symptoms-input { flex: 1; padding: 10px; border: none; border-radius: 20px; outline: none; }
        button { border: none; background: #25d366; color: white; padding: 10px; border-radius: 50%; cursor: pointer; margin-left: 5px; font-size: 16px; }
        #voice-btn.recording { background: red; }
        #image-input { display: none; }
        .drag-drop { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 10px; border-radius: 10px; background: #fafafa; }
        .drag-drop.dragover { border-color: #25d366; }
        @media (max-width: 600px) { .chat-container { border-radius: 0; height: 100vh; width: 100%; } }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">HealthMate - AI Symptom Companion</div>
        <div id="chat-box" class="chat-box"></div>
        <div class="input-area">
            <input type="text" id="symptoms-input" placeholder="Describe your symptoms... (emojis supported! üòä)">
            <input type="file" id="image-input" accept="image/*">
            <button id="image-btn" title="Upload Image">üì∑</button>
            <button id="voice-btn" title="Record Voice">üé§</button>
            <button id="send-btn" title="Send">‚û§</button>
            <button id="clear-btn" title="Clear History">üóëÔ∏è</button>
        </div>
        <div id="drag-drop" class="drag-drop" style="display: none;">Drop image here or click to select</div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const symptomsInput = document.getElementById('symptoms-input');
        const imageInput = document.getElementById('image-input');
        const imageBtn = document.getElementById('image-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const dragDrop = document.getElementById('drag-drop');

        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Base URL for backend (update if not localhost:5000)
        const BASE_URL = 'http://localhost:5000';

        // Render chat history with Markdown rendering
        function renderHistory() {
            chatBox.innerHTML = '';
            chatHistory.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${msg.role === 'user' ? 'user' : 'bot'}`;
                // Parse Markdown and sanitize HTML
                const renderedContent = DOMPurify.sanitize(marked.parse(msg.content));
                msgDiv.innerHTML = `
                    <div class="bubble">${renderedContent}</div>
                    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                `;
                chatBox.appendChild(msgDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        renderHistory();

        // Helper to add messages to chat
        function addMessage(role, content) {
            chatHistory.push({ role, content });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderHistory();
        }

        // Image upload
        imageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', () => {
            if (imageInput.files[0]) sendMessage();
        });

        // Drag and drop for images
        dragDrop.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDrop.classList.add('dragover');
        });
        dragDrop.addEventListener('dragleave', () => {
            dragDrop.classList.remove('dragover');
        });
        dragDrop.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDrop.classList.remove('dragover');
            imageInput.files = e.dataTransfer.files;
            sendMessage();
        });

        // Voice recording
        voiceBtn.addEventListener('click', async () => {
            if (isRecording) {
                mediaRecorder.stop();
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'üé§';
                isRecording = false;
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendVoice(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorder.start();
                    voiceBtn.classList.add('recording');
                    voiceBtn.textContent = 'üî¥';
                    isRecording = true;
                } catch (err) {
                    console.error('Voice error:', err);
                    addMessage('bot', 'Voice recording not supported or permission denied. Please try again.');
                }
            }
        });

        // Send message
        sendBtn.addEventListener('click', sendMessage);
        symptomsInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const symptoms = symptomsInput.value.trim();
            const imageFile = imageInput.files[0];

            if (!symptoms && !imageFile) return;

            const formData = new FormData();
            if (symptoms) formData.append('symptoms', symptoms);
            if (imageFile) formData.append('image', imageFile);

            console.log('Sending message to:', BASE_URL + '/get_response');
            try {
                const response = await fetch(BASE_URL + '/get_response', { method: 'POST', body: formData });
                console.log('Fetch status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Response data:', data);
                if (data.history) {
                    chatHistory = data.history;
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderHistory();
                }
                if (data.response && !data.history) {  // Handle errors as bot messages
                    addMessage('bot', data.response);
                }
            } catch (err) {
                console.error('Send error:', err);
                addMessage('bot', 'Error sending message: ' + err.message + '. Please try again.');
            }

            symptomsInput.value = '';
            imageInput.value = '';
        }

        async function sendVoice(audioBlob) {
            const formData = new FormData();
            formData.append('voice', audioBlob, 'voice.wav');

            console.log('Sending voice to:', BASE_URL + '/get_response');
            try {
                const response = await fetch(BASE_URL + '/get_response', { method: 'POST', body: formData });
                console.log('Voice fetch status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Voice response data:', data);
                if (data.history) {
                    chatHistory = data.history;
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    renderHistory();
                }
            } catch (err) {
                console.error('Voice send error:', err);
                addMessage('bot', 'Error sending voice: ' + err.message + '. Please try again.');
            }
        }

        // Clear history
        clearBtn.addEventListener('click', async () => {
            console.log('Clearing history at:', BASE_URL + '/clear_history');
            try {
                const response = await fetch(BASE_URL + '/clear_history', { method: 'POST' });
                console.log('Clear fetch status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                chatHistory = [];
                localStorage.removeItem('chatHistory');
                renderHistory();
            } catch (err) {
                console.error('Clear error:', err);
                addMessage('bot', 'Error clearing history: ' + err.message + '. Please try again.');
            }
        });
    </script>
</body>
</html>